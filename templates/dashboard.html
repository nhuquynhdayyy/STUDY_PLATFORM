<!-- templates/dashboard.html -->
{% extends 'base.html' %}

{% block content %}
<div class="flex justify-between items-center mb-10">
    <div>
        <h1 class="text-3xl font-bold text-slate-800">Welcome back, {{ user.username }}</h1>
        <p class="text-gray-400">Track your progress and stay focused.</p>
    </div>
    
    {% if active_session %}
    <div class="bg-slate-900 text-white p-4 rounded-2xl flex items-center gap-6 shadow-xl border border-slate-700">
        <div>
            <p class="text-[10px] text-teal-400 font-bold uppercase tracking-widest">Currently Focusing</p>
            <p class="text-lg font-bold">{{ active_session.subject.name }}</p>
        </div>
        <div class="text-2xl font-mono font-bold text-white border-l border-slate-700 pl-6">
            <span id="live-timer">00:00:00</span>
        </div>
        <form action="{% url 'stop_study' %}" method="POST">
            {% csrf_token %}
            <button type="submit" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-bold transition">
                End Session
            </button>
        </form>
    </div>
    {% endif %}
</div> 

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
        <!-- Cột trái: Tạo phòng nhanh -->
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-[2.5rem] text-white shadow-xl">
            <h3 class="text-xl font-bold mb-2">Start Group Study</h3>
            <p class="text-slate-400 text-sm mb-6">Create a room and invite your friends to study together with video call.</p>
            
            <form action="{% url 'create_group_room' %}" method="POST" class="flex gap-2">
                {% csrf_token %}
                <input type="text" name="room_name" placeholder="Room Name (e.g. Python Team)" required
                    class="flex-1 bg-slate-700 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-xl font-bold transition">
                    Create Room
                </button>
            </form>
        </div>
        
        <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm">
            <h3 class="text-xl font-bold text-slate-800 mb-2">Join with Code</h3>
            <p class="text-gray-400 text-sm mb-6">Enter a room code sent by your friend to join their session.</p>
            
            <!-- Thêm ID cho form và bỏ action cũ -->
            <form id="join-room-form" class="flex gap-2">
                {% csrf_token %}
                <input type="text" id="input-room-code" name="room_code" placeholder="Example: AB82-C9" required
                    class="flex-1 bg-slate-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-slate-900 hover:bg-black text-white px-6 py-3 rounded-xl font-bold transition">
                    Join Now
                </button>
            </form>
        </div>

        <!-- SCRIPT XỬ LÝ POPUP THÔNG BÁO -->
        <script>
        // Cấu hình Toast (thông báo nhỏ ở góc)
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        document.getElementById('join-room-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const btn = this.querySelector('button');
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Icon xoay
            btn.disabled = true;

            try {
                const response = await fetch("{% url 'join_group_room' %}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Hiển thị Toast thành công trước khi đi tới phòng
                    await Toast.fire({
                        icon: 'success',
                        title: 'Joining room...'
                    });
                    window.location.href = result.redirect_url;
                } else {
                    // HIỂN THỊ MODAL LỖI HIỆN ĐẠI
                    Swal.fire({
                        icon: 'error',
                        title: 'Access Denied',
                        text: result.message,
                        confirmButtonColor: '#2563eb', // Màu Blue-600 của bạn
                        background: '#ffffff',
                        customClass: {
                            title: 'text-slate-800',
                            content: 'text-slate-600'
                        }
                    });
                    btn.innerText = "Join Now";
                    btn.disabled = false;
                }
            } catch (error) {
                Toast.fire({ icon: 'error', title: 'Connection lost!' });
                btn.innerText = "Join Now";
                btn.disabled = false;
            }
        });
        </script>
    </div>

<!-- My Subjects -->
<h2 class="text-xl font-bold mb-6 text-slate-800">My Subjects</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
    {% for s in subjects %}
    <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 hover:shadow-md transition">
        <div class="flex justify-between items-start mb-6">
            <div class="p-3 rounded-2xl bg-orange-50 text-orange-500"><i class="fas fa-book-open"></i></div>
            <i class="fas fa-ellipsis-v text-gray-300"></i>
        </div>
        <h3 class="text-lg font-bold mb-1">{{ s.name }}</h3>
        <p class="text-gray-400 text-sm mb-6">Active Learning</p>
        <div class="flex justify-between items-center">
            <span class="text-xs text-gray-400 italic">Ready to focus?</span>
            {% if not active_session %}
            <form action="{% url 'start_study' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="subject_id" value="{{ s.id }}">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl text-sm font-bold transition">Start Study</button>
            </form>
            {% else %}
            <button class="bg-gray-100 text-gray-400 px-5 py-2 rounded-xl text-sm font-bold cursor-not-allowed" disabled>In Progress</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Recent Activity (History) -->
<div class="flex justify-between items-center mb-6">
    <h2 class="text-xl font-bold text-slate-800">Recent Activity</h2>
    <a href="{% url 'history' %}" class="text-blue-600 text-sm font-semibold hover:underline">View All</a>
</div>
<div class="bg-white rounded-[2rem] border border-gray-100 overflow-hidden shadow-sm">
    <table class="w-full text-left border-collapse">
        <thead>
            <!-- SỬA TẠI ĐÂY: Thêm 1 cột tiêu đề để đủ 4 cột -->
            <tr class="bg-gray-50 border-b border-gray-100 text-gray-400 text-[10px] uppercase tracking-widest">
                <th class="px-8 py-4 font-semibold">Subject</th>
                <th class="px-8 py-4 font-semibold">Date</th>
                <th class="px-8 py-4 font-semibold">Type</th> <!-- Thêm cột này -->
                <th class="px-8 py-4 font-semibold text-right">Duration</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-50">
            {% for record in recent_history %}
            <tr class="hover:bg-blue-50/30 transition">
                <!-- Cột 1: Subject -->
                <td class="px-8 py-4">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full" style="background-color: {{ record.get_color }}"></div>
                        <span class="font-bold text-gray-700">{{ record.display_name }}</span>
                    </div>
                </td>

                <!-- Cột 2: Date -->
                <td class="px-8 py-4 text-gray-400 text-sm">
                    {{ record.end_time|date:"M d, Y" }}
                </td>
                
                <!-- Cột 3: Type (Badge) -->
                <td class="px-8 py-4">
                    {% if record.session_type == 'group' %}
                        <span class="text-[9px] bg-slate-100 text-slate-500 px-2 py-1 rounded font-bold uppercase">Group</span>
                    {% else %}
                        <span class="text-[9px] bg-blue-50 text-blue-500 px-2 py-1 rounded font-bold uppercase">Solo</span>
                    {% endif %}
                </td>

                <!-- Cột 4: Duration -->
                <td class="px-8 py-4 text-right font-mono font-bold text-blue-600">
                    <span id="dur-{{ record.id }}">{{ record.duration }}s</span>
                    <script>
                        (function() {
                            var s = {{ record.duration }};
                            var m = Math.floor(s/60);
                            var sec = s % 60;
                            document.getElementById("dur-{{ record.id }}").innerText = m + "m " + sec + "s";
                        })();
                    </script>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Logic cho Create Room
document.querySelector('form[action*="create_group_room"]').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    try {
        const response = await fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
        });
        const result = await response.json();

        if (result.success) {
            Swal.fire({
                icon: 'success',
                title: 'Phòng đã sẵn sàng!',
                text: 'Hệ thống đang chuyển bạn vào phòng học...',
                showConfirmButton: false,
                timer: 1500
            }).then(() => {
                window.location.href = result.redirect_url;
            });
        }
    } catch (error) {
        Toast.fire({ icon: 'error', title: 'Could not create room' });
    }
});
</script>

{% if active_session %}
<script>
    const startTime = new Date("{{ active_session.start_time|date:'c' }}").getTime();
    function updateTimer() {
        const now = new Date().getTime();
        const distance = now - startTime;
        const hours = Math.floor(distance / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        document.getElementById("live-timer").innerText = 
            (hours < 10 ? "0" + hours : hours) + ":" + 
            (minutes < 10 ? "0" + minutes : minutes) + ":" + 
            (seconds < 10 ? "0" + seconds : seconds);
    }
    setInterval(updateTimer, 1000);
    updateTimer();
</script>
{% endif %}
{% endblock %}
<!-- templates/dashboard.html -->
{% extends 'base.html' %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- TOP HEADER: GIỮ NGUYÊN LOGIC ACTIVE SESSION -->
    <div class="flex justify-between items-center mb-10">
        <div>
            <h1 class="text-4xl font-black text-slate-900">Welcome back, {{ user.username }}</h1>
            <p class="text-slate-400 font-medium">{{ now|date:"l, F dS" }}</p>
        </div>
        
        {% if active_session %}
        <div class="bg-slate-900 text-white p-4 rounded-3xl flex items-center gap-6 shadow-2xl border border-slate-700">
            <div>
                <p class="text-[10px] text-teal-400 font-bold uppercase tracking-widest">Focusing</p>
                <p class="text-lg font-bold">{{ active_session.display_name }}</p>
            </div>
            <div class="text-2xl font-mono font-bold text-white border-l border-slate-700 pl-6">
                <span id="live-timer">00:00:00</span>
            </div>
            <form action="{% url 'stop_study' %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="bg-red-500 hover:bg-red-600 px-6 py-2 rounded-xl text-sm font-bold transition">End</button>
            </form>
        </div>
        {% else %}
        <div class="flex gap-3">
            <button class="bg-white border border-slate-200 px-6 py-3 rounded-2xl font-bold text-slate-700"><i class="fas fa-plus mr-2"></i>New Task</button>
            <button class="bg-teal-600 px-6 py-3 rounded-2xl font-bold text-white shadow-lg shadow-teal-100">Quick Start</button>
        </div>
        {% endif %}
    </div>

    <!-- STATS CARDS (DỮ LIỆU TỪ DB) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex justify-between items-center">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Total Hours This Week</p>
                <h3 class="text-3xl font-black text-slate-800">{{ total_hours }} hrs <span class="text-sm text-green-500 font-bold">~20%</span></h3>
            </div>
            <div class="text-blue-500 text-2xl bg-blue-50 w-12 h-12 rounded-full flex items-center justify-center"><i class="far fa-clock"></i></div>
        </div>
        <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 flex justify-between items-center">
            <div>
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Current Streak</p>
                <h3 class="text-3xl font-black text-slate-800">{{ streak }} Days <span class="text-sm text-orange-500 font-bold">+1</span></h3>
            </div>
            <div class="text-orange-500 text-2xl bg-orange-50 w-12 h-12 rounded-full flex items-center justify-center"><i class="fas fa-fire"></i></div>
        </div>
        <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
            <p class="text-slate-400 text-xs font-bold uppercase mb-2">Weekly Goal Progress</p>
            <h3 class="text-3xl font-black text-slate-800 mb-3">{{ goal_percent }}%</h3>
            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                <div class="bg-teal-500 h-full" style="width: {{ goal_percent }}%"></div>
            </div>
        </div>
    </div>

    <!-- MAIN GRID: CHART & GROUP ACTIONS -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
        <div class="lg:col-span-2 bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100">
            <h3 class="text-xl font-bold mb-8">Study Focus Distribution</h3>
            <canvas id="distributionChart" height="120"></canvas>
        </div>

        <!-- ACTION BOXES: GIỮ NGUYÊN FORM CŨ ĐỂ KHÔNG BỊ DISABLED -->
        <div class="space-y-6">
            <div class="bg-slate-900 p-8 rounded-[2.5rem] text-white">
                <h3 class="font-bold mb-2">Start Group Study</h3>
                <form action="{% url 'create_group_room' %}" method="POST" class="space-y-3">
                    {% csrf_token %}
                    <input type="text" name="room_name" placeholder="Room Name..." required class="w-full bg-slate-800 border-none rounded-xl px-4 py-2 text-sm">
                    <button type="submit" class="w-full bg-blue-600 py-3 rounded-xl font-bold">Create Room</button>
                </form>
            </div>
            <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-2">Join with Code</h3>
                <form id="join-room-form" class="space-y-3">
                    {% csrf_token %}
                    <input type="text" name="room_code" placeholder="AB82-C9" required class="w-full bg-slate-50 border-none rounded-xl px-4 py-2 text-sm">
                    <button type="submit" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Join Now</button>
                </form>
            </div>
        </div>
    </div>

    <!-- MY SUBJECTS: CẬP NHẬT CARD MỚI NHƯNG GIỮ NÚT START STUDY -->
    <h2 class="text-2xl font-bold mb-8 text-slate-800">My Subjects</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
        {% for s in subjects %}
        <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-50">
            <div class="flex justify-between items-start mb-6">
                <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-white" style="background-color: {{ s.color }}"><i class="fas fa-book"></i></div>
                <button class="text-slate-300"><i class="fas fa-ellipsis-v"></i></button>
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-1">{{ s.name }}</h3>
            <p class="text-slate-400 text-xs mb-6">Progress: {{ s.progress }}%</p>
            <div class="w-full bg-slate-50 h-1 rounded-full mb-8">
                <div class="h-full bg-blue-500" style="width: {{ s.progress }}%; background-color: {{ s.color }}"></div>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-[10px] text-slate-300 italic">Last studied: Today</span>
                {% if not active_session %}
                <form action="{% url 'start_study' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="subject_id" value="{{ s.id }}">
                    <button type="submit" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-bold">Start Study</button>
                </form>
                {% else %}
                <button class="bg-slate-100 text-slate-400 px-5 py-2 rounded-xl text-xs font-bold" disabled>Busy</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- RECENT ACTIVITY: GIỮ NGUYÊN BẢNG ĐANG CHẠY -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-slate-800">Recent Activity</h2>
        <a href="{% url 'history' %}" class="text-blue-600 font-bold text-sm">View All</a>
    </div>
    <div class="bg-white rounded-[2.5rem] border border-slate-100 overflow-hidden shadow-sm mb-20">
        <table class="w-full text-left">
            <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase tracking-widest">
                <tr>
                    <th class="px-10 py-5">Subject</th>
                    <th class="px-10 py-5">Date</th>
                    <th class="px-10 py-5">Type</th>
                    <th class="px-10 py-5 text-right">Duration</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-50">
                {% for record in recent_history %}
                <tr class="hover:bg-slate-50/50 transition">
                    <td class="px-10 py-5"><div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full" style="background-color: {{ record.get_color }}"></div><span class="font-bold text-slate-700">{{ record.display_name }}</span></div></td>
                    <td class="px-10 py-5 text-slate-400 text-sm">{{ record.end_time|date:"M d, Y" }}</td>
                    <td class="px-10 py-5"><span class="text-[9px] {% if record.session_type == 'group' %}bg-slate-100 text-slate-500{% else %}bg-blue-50 text-blue-500{% endif %} px-2 py-1 rounded font-bold uppercase">{{ record.session_type }}</span></td>
                    <td class="px-10 py-5 text-right font-mono font-bold text-blue-600" id="dur-{{ record.id }}">
                        {{ record.formatted_duration }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- SCRIPTS: GIỮ NGUYÊN LOGIC ĐÃ CHẠY ĐỂ KHÔNG MẤT CHỨC NĂNG -->
<script>
    // 1. Chart Distribution
    const ctx = document.getElementById('distributionChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                data: {{ chart_data|safe }},
                backgroundColor: '#0f172a',
                borderRadius: 10,
                barThickness: 40
            }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
    });

    // 2. Timer Logic (Nếu có active_session)
    {% if active_session %}
    const startTime = new Date("{{ active_session.start_time|date:'c' }}").getTime();
    setInterval(() => {
        const now = new Date().getTime();
        const diff = now - startTime;
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        document.getElementById("live-timer").innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }, 1000);
    {% endif %}

    // 3. Join Room Logic (Giữ nguyên Script AJAX cũ của bạn)
    document.getElementById('join-room-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        try {
            const res = await fetch("{% url 'join_group_room' %}", { method: 'POST', body: formData, headers: {'X-CSRFToken': formData.get('csrfmiddlewaretoken')} });
            const result = await res.json();
            if (result.success) window.location.href = result.redirect_url;
            else Swal.fire('Error', result.message, 'error');
        } catch (e) { console.error(e); }
    });
</script>
{% endblock %}